<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>XP 排行榜 · 分页版 & 详情查询</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="color-scheme" content="light dark">
<style>
:root{
  --c-bg:#f9f9f9;--c-card:#fff;--c-text:#222;--c-sub:#666;--c-primary:#0078d4;
}
@media (prefers-color-scheme:dark){
  :root{--c-bg:#111827;--c-card:#1f2937;--c-text:#f3f4f6;--c-sub:#9ca3af;}
}
body{margin:0;background:var(--c-bg);color:var(--c-text);
     font-family:-apple-system,Segoe UI,PingFang SC,Helvetica,Arial,sans-serif;}
h2{margin:24px 0;text-align:center;color:var(--c-primary);}
.container{max-width:880px;margin:0 auto 60px;padding:0 12px;}
.progress{font-size:14px;color:var(--c-sub);margin-bottom:12px;}
.table-wrap{border:1px solid #ddd;border-radius:10px;overflow:auto;max-height:70vh;}
table{width:100%;border-collapse:collapse;font-size:14px;}
th,td{padding:6px 8px;border-bottom:1px solid #e5e7eb;vertical-align:top;}
th{position:sticky;top:0;background:var(--c-card);}
.rank{width:60px;text-align:center;font-weight:700;}
.addr a{color:var(--c-primary);text-decoration:none;}
.addr a:hover{text-decoration:underline;}
.xp{text-align:right;font-variant-numeric:tabular-nums;}
.btn-detail{background:none;border:none;color:var(--c-primary);cursor:pointer;}
.detail-row{background:var(--c-card);}
.detail-box{padding:10px 14px;font-size:13px;color:var(--c-text);}
.detail-box b{display:inline-block;width:90px;}
.error{color:#dc2626;}
.nav{display:flex;gap:12px;align-items:center;justify-content:center;margin:16px 0;font-size:15px;}
.nav input{width:90px;padding:6px 8px;font-size:15px;border:1px solid #ccc;border-radius:8px;text-align:center;}
.nav button{padding:6px 14px;border:none;border-radius:8px;background:var(--c-primary);color:#fff;cursor:pointer;}
.nav button:disabled{opacity:.5;cursor:default;}
@media (prefers-color-scheme:dark){
  .table-wrap{border-color:#374151;}
  th,td{border-color:#374151;}
}
</style>
</head>
<body>
<h2>XP 排行榜</h2>
<div class="container">
  <div class="progress" id="status">加载数据中…</div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr><th class="rank">#</th><th>地址</th><th class="xp">XP</th><th>操作</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="nav">
    <button id="prevBtn">上一页</button>
    <span>第 <input id="pageInput" type="number" min="1" value="1"> / <span id="totalPages">?</span> 页</span>
    <button id="nextBtn">下一页</button>
  </div>
</div>

<script>
/* ====== 全局变量 ====== */
const PAGE_SIZE = 10000;
let data = [];          // [ [addr, xp], ... ]
let totalPages = 0;
let currentPage = 1;

/* ====== 元素 ====== */
const tbody     = document.getElementById('tbody');
const statusEl  = document.getElementById('status');
const pageInput = document.getElementById('pageInput');
const totalEl   = document.getElementById('totalPages');
const prevBtn   = document.getElementById('prevBtn');
const nextBtn   = document.getElementById('nextBtn');

/* ====== 读取 TXT ====== */
fetch('data.txt')
  .then(r=>r.text())
  .then(txt=>{
    const lines = txt.trim().split(/\r?\n/);
    lines.forEach(line=>{
      // 允许格式：rank addr xp(带逗号)
      const parts = line.trim().split(/\s+/);
      if(parts.length>=3){
        const addr = parts[1];
        const xp   = Number(parts[2].replace(/,/g,''));
        data.push([addr,xp]);
      }
    });
    data.sort((a,b)=>b[1]-a[1]); // 按 XP 降序

    totalPages = Math.ceil(data.length / PAGE_SIZE);
    totalEl.textContent = totalPages;
    statusEl.textContent = `共 ${data.length.toLocaleString()} 条 · 每页 ${PAGE_SIZE.toLocaleString()} 条`;
    renderPage(1);
  })
  .catch(err=>{
    statusEl.textContent = '加载失败：'+err.message;
  });

/* ====== 渲染指定页 ====== */
function renderPage(page){
  if(page<1||page>totalPages) return;
  currentPage = page;
  pageInput.value = page;
  prevBtn.disabled = page===1;
  nextBtn.disabled = page===totalPages;

  const start = (page-1)*PAGE_SIZE;
  const end   = Math.min(start + PAGE_SIZE, data.length);
  const rows = [];
  for(let i=start;i<end;i++){
    const [addr,xp] = data[i];
    rows.push(`
      <tr>
        <td class="rank">${i+1}</td>
        <td class="addr"><a href="https://debank.com/profile/${addr}" target="_blank">${addr}</a></td>
        <td class="xp">${xp.toLocaleString()}</td>
        <td><button class="btn-detail" data-addr="${addr}">🔍</button></td>
      </tr>
    `);
  }
  tbody.innerHTML = rows.join('');
  tableWrap.scrollTop = 0;
}

/* ====== Fetch XP 详情 ====== */
async function fetchDetail(addr){
  const body = JSON.stringify({
    operationName:"RewardsActivityTable",
    query:`query RewardsActivityTable($address: Address!, $limit: Int!, $cursor: String) {
      rewardActivity(address: $address, limit: $limit, cursor: $cursor) {
        items { eventTime amount name tier direction }
        nextPageCursor
      }
    }`,
    variables:{address:addr,limit:25}
  });
  try{
    const res = await fetch('https://gql.opensea.io/graphql',{
      method:'POST',
      headers:{
        'content-type':'application/json',
        'x-app-id':'os2-web'          // 必需 header
      },
      body
    });
    if(!res.ok) throw new Error(res.status+' '+res.statusText);
    const json = await res.json();
    return json.data?.rewardActivity?.items || [];
  }catch(e){
    throw e;
  }
}

/* ====== 展开 / 收起逻辑 ====== */
tbody.addEventListener('click',async e=>{
  if(!e.target.matches('.btn-detail')) return;
  const btn = e.target;
  const addr = btn.dataset.addr;
  const tr   = btn.closest('tr');

  // 已展开则收起
  if(tr.nextSibling && tr.nextSibling.classList.contains('detail-row')){
    tr.parentNode.removeChild(tr.nextSibling);
    return;
  }

  // 先插入占位行
  const detailTr = document.createElement('tr');
  detailTr.className='detail-row';
  detailTr.innerHTML = `<td colspan="4" class="detail-box">加载中…</td>`;
  tr.after(detailTr);

  try{
    const items = await fetchDetail(addr);
    if(!items.length){
      detailTr.querySelector('.detail-box').innerHTML = '无记录';
      return;
    }
    const html = items.map(it=>`
      <div>
        <b>${new Date(it.eventTime).toLocaleString()}</b>
        <span>+${it.amount}</span> —
        <span>${it.name}</span>
        <i style="color:var(--c-sub)">(${it.tier})</i>
      </div>`).join('');
    detailTr.querySelector('.detail-box').innerHTML = html;
  }catch(err){
    detailTr.querySelector('.detail-box').innerHTML =
      `<span class="error">获取失败：${err.message}</span>`;
  }
});

/* ====== 翻页事件 ====== */
prevBtn.onclick = ()=>renderPage(currentPage-1);
nextBtn.onclick = ()=>renderPage(currentPage+1);
pageInput.onchange = ()=>renderPage(Number(pageInput.value));
</script>
</body>
</html>
